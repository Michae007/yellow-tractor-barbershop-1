name: COMPLETE FIX - Create Gradle and Build APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Environment
      uses: android-actions/setup-android@v3
      
    - name: ğŸ”§ Check Project Structure
      run: |
        echo "=== ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° ==="
        cd android-app
        ls -la
        echo "=== ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Gradle Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² ==="
        find . -name "*.gradle" -type f || echo "Gradle Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"
        
    - name: ğŸ› ï¸ Install Gradle and Create Wrapper
      run: |
        cd android-app
        
        echo "=== Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Gradle ==="
        sudo apt update
        sudo apt install -y gradle
        
        echo "=== Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Gradle Wrapper ==="
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ build.gradle ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
        if [ ! -f "build.gradle" ]; then
          cat > build.gradle << 'EOF'
// Top-level build file
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath "com.android.tools.build:gradle:7.4.2"
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
EOF
        fi
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ gradle wrapper
        gradle wrapper --gradle-version=7.5
        
        echo "=== ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ gradlew ==="
        ls -la gradlew || echo "gradlew Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
        
    - name: ğŸ—ï¸ Build with System Gradle
      run: |
        cd android-app
        
        echo "=== ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¼ Gradle ==="
        gradle tasks | grep -i "assemble\|build" | head -10 || echo "Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"
        
        # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑĞ±Ğ¾Ñ€ĞºĞ¸
        gradle build || gradle assemble || gradle assembleDebug || echo "Ğ’ÑĞµ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸ÑÑŒ"
        
    - name: ğŸ“‹ Find Any Build Results
      run: |
        echo "=== Ğ˜Ñ‰ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ ÑĞ±Ğ¾Ñ€ĞºĞ¸ ==="
        find android-app -name "*.apk" -type f | head -10 || echo "APK Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"
        find android-app -name "build" -type d | head -5
        find android-app -name "outputs" -type d | head -5
        
    - name: â¬†ï¸ Upload Everything
      uses: actions/upload-artifact@v4
      with:
        name: complete-build-results
        path: |
          android-app/
        retention-days: 1
