name: FINAL APK BUILD

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Debug Project Structure
      run: |
        echo "=== ÐŸÐžÐ›ÐÐÐ¯ Ð”Ð˜ÐÐ“ÐÐžÐ¡Ð¢Ð˜ÐšÐ ==="
        cd android-app
        echo "1. Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹:"
        ls -la
        echo ""
        echo "2. Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ app:"
        ls -la app/ || echo "ÐÐµÑ‚ app"
        echo ""
        echo "3. ÐšÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ build.gradle:"
        cat build.gradle
        echo ""
        echo "4. app/build.gradle:"
        cat app/build.gradle || echo "ÐÐµÑ‚ app/build.gradle"
        echo ""
        echo "5. settings.gradle:"
        cat settings.gradle
        echo ""
        echo "6. Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Gradle:"
        gradle tasks --no-daemon | grep -i "assemble\|build\|android" | head -20 || echo "ÐÐµÑ‚ Android Ð·Ð°Ð´Ð°Ñ‡"
        
    - name: ðŸ› ï¸ Create Missing Files
      run: |
        cd android-app
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ app/build.gradle ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
        if [ ! -f "app/build.gradle" ]; then
          echo "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ app/build.gradle..."
          mkdir -p app
          cat > app/build.gradle << 'EOF'
plugins {
    id 'com.android.application'
}

android {
    compileSdk 33
    namespace 'com.example.app'

    defaultConfig {
        applicationId "com.example.app"
        minSdk 21
        targetSdk 33
        versionCode 1
        versionName "1.0"
    }

    buildTypes {
        debug {
            debuggable true
        }
    }
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
}
EOF
        fi
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ gradlew
        if [ ! -f "gradlew" ]; then
          echo "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Gradle Wrapper..."
          gradle wrapper --gradle-version=7.5
        fi
        
    - name: ðŸ—ï¸ Build with Correct Command
      run: |
        cd android-app
        chmod +x ./gradlew
        
        # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ñ€Ð°Ð·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸
        echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 1: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
        ./gradlew build --no-daemon || echo "Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ"
        
        echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 2: Ð—Ð°Ð´Ð°Ñ‡Ð¸ app Ð¼Ð¾Ð´ÑƒÐ»Ñ"
        ./gradlew :app:assembleDebug --no-daemon || echo "app:assembleDebug Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ"
        
        echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 3: Ð’ÑÐµ Ð·Ð°Ð´Ð°Ñ‡Ð¸"
        ./gradlew tasks --no-daemon | grep -i "assemble" | head -10 || echo "ÐÐµÑ‚ assemble Ð·Ð°Ð´Ð°Ñ‡"
        
    - name: ðŸ“¦ Find and Upload APK
      run: |
        echo "ÐŸÐ¾Ð¸ÑÐº APK Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
        find . -name "*.apk" -type f | head -10 || echo "APK Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        
    - name: â¬†ï¸ Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: build-results
        path: |
          android-app/app/build/outputs/apk/**/*.apk
          **/build/outputs/apk/**/*.apk
        retention-days: 7
