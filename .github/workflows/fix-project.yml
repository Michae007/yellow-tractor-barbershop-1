name: FIX ANDROID PROJECT

on:
  workflow_dispatch:

jobs:
  fix-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Analyze Project Structure
      run: |
        echo "=== ĞĞĞĞ›Ğ˜Ğ— Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ« ĞŸĞ ĞĞ•ĞšĞ¢Ğ ==="
        cd android-app
        echo "1. Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ² android-app:"
        ls -la
        echo ""
        echo "2. Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ app:"
        ls -la app/ || echo "âŒ ĞŸĞ°Ğ¿ĞºĞ° app Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°!"
        echo ""
        echo "3. Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ build.gradle:"
        cat build.gradle || echo "âŒ Ğ¤Ğ°Ğ¹Ğ» build.gradle Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!"
        echo ""
        echo "4. Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ app/build.gradle:"
        cat app/build.gradle || echo "âŒ Ğ¤Ğ°Ğ¹Ğ» app/build.gradle Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!"
        
    - name: ğŸ› ï¸ Fix Project Structure
      run: |
        cd android-app
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ build.gradle
        if [ ! -f "build.gradle" ] || [ ! -s "build.gradle" ]; then
          echo "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ build.gradle..."
          cat > build.gradle << 'EOF'
// Top-level build file where you can add configuration options common to all sub-projects/modules.
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath "com.android.tools.build:gradle:7.4.2"
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
EOF
        fi
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ app/build.gradle
        if [ ! -f "app/build.gradle" ] || [ ! -s "app/build.gradle" ]; then
          echo "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ app/build.gradle..."
          mkdir -p app
          cat > app/build.gradle << 'EOF'
plugins {
    id 'com.android.application'
}

android {
    compileSdk 33

    defaultConfig {
        applicationId "com.example.myapp"
        minSdk 21
        targetSdk 33
        versionCode 1
        versionName "1.0"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
        debug {
            debuggable true
        }
    }
}

dependencies {
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.8.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
}
EOF
        fi
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ gradle wrapper ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
        if [ ! -f "gradlew" ]; then
          echo "ğŸ”§ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Gradle Wrapper..."
          gradle wrapper --gradle-version=7.5
        fi
        
    - name: ğŸ—ï¸ Build Fixed Project
      run: |
        cd android-app
        chmod +x ./gradlew
        ./gradlew :app:assembleDebug --stacktrace
        
    - name: ğŸ“¦ Find APK Files
      run: |
        echo "ğŸ” Ğ˜Ñ‰ĞµĞ¼ APK Ñ„Ğ°Ğ¹Ğ»Ñ‹..."
        find . -name "*.apk" -type f | head -10 || echo "APK Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"
        
    - name: â¬†ï¸ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: fixed-android-apk
        path: android-app/app/build/outputs/apk/**/*.apk
        retention-days: 7
